name: Test Clean Install

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Show environment
        run: |
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
          echo "Python: $(python3 --version)"
          echo "Docker: $(docker --version)"
          
      - name: Clean environment (remove any pre-existing)
        run: |
          rm -rf ~/.simplifia ~/.local/bin/simplifia 2>/dev/null || true
          pip3 uninstall simplifia -y 2>/dev/null || true
          
      - name: Run installer
        run: |
          curl -fsSL https://raw.githubusercontent.com/pala7777/simplifia-installer/main/packaging/install.sh | SIMPLIFIA_NONINTERACTIVE=1 bash
          
      - name: Add to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
        
      - name: Verify CLI
        run: |
          simplifia --version
          
      - name: Run doctor
        run: |
          simplifia doctor
          
      - name: List packs
        run: |
          simplifia list
          
      - name: Install WhatsApp pack
        run: |
          simplifia install whatsapp
          
      - name: Test WhatsApp pack
        run: |
          simplifia test whatsapp
          
      - name: Show status
        run: |
          simplifia status
          
      - name: Check Docker availability
        id: docker-check
        run: |
          if docker info >/dev/null 2>&1; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "Docker is available"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "Docker is NOT available - skipping runtime tests"
          fi

      # NOTE: Runtime test skipped - Docker image not yet published
      # TODO: Enable when ghcr.io/clawdbot/clawdbot image is available
      # - name: Test runtime install (Docker)
      #   if: steps.docker-check.outputs.available == 'true'
      #   run: |
      #     simplifia clawdbot doctor
      #     SIMPLIFIA_NONINTERACTIVE=1 simplifia clawdbot install --docker
      #     simplifia clawdbot start
      #     sleep 10
      #     docker ps
      #     simplifia clawdbot status
      
      - name: Verify clawdbot install (without running)
        if: steps.docker-check.outputs.available == 'true'
        run: |
          simplifia clawdbot doctor
          SIMPLIFIA_NONINTERACTIVE=1 simplifia clawdbot install --docker || true
          ls -la ~/.simplifia/clawdbot/ || echo "Clawdbot dir not created"
          cat ~/.simplifia/clawdbot/docker-compose.yml || echo "docker-compose.yml not found"

  test-windows:
    runs-on: windows-latest
    
    steps:
      - name: Show environment
        shell: pwsh
        run: |
          Write-Host "OS: $([System.Environment]::OSVersion)"
          Write-Host "Python: $(python --version)"
          Write-Host "Docker: $(docker --version)"
          
      - name: Clean environment
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force "$env:USERPROFILE\.simplifia" -ErrorAction SilentlyContinue
          pip uninstall simplifia -y 2>$null
          
      - name: Run installer
        shell: pwsh
        run: |
          $env:SIMPLIFIA_NONINTERACTIVE = "1"
          $env:PYTHONIOENCODING = "utf-8"
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001
          irm https://raw.githubusercontent.com/pala7777/simplifia-installer/main/packaging/install.ps1 | iex
          
      - name: Add Python Scripts to PATH
        shell: pwsh
        run: |
          # Get Python version for versioned Scripts path
          $pyVersion = (python -c "import sys; print(f'{sys.version_info.major}{sys.version_info.minor}')").Trim()
          $userBase = (python -c "import site; print(site.USER_BASE)").Trim()
          Write-Host "Python version: $pyVersion, USER_BASE: $userBase"
          
          # Windows pip --user installs to Python<VERSION>\Scripts, not just Scripts
          $versionedScripts = Join-Path $userBase "Python$pyVersion\Scripts"
          $plainScripts = Join-Path $userBase "Scripts"
          $systemScripts = (python -c "import sys; print(sys.prefix)").Trim() + "\Scripts"
          
          Write-Host "Checking paths:"
          Write-Host "  Versioned: $versionedScripts"
          Write-Host "  Plain: $plainScripts"
          Write-Host "  System: $systemScripts"
          
          # Try versioned path first (Python312\Scripts)
          if (Test-Path "$versionedScripts\simplifia.exe" -ErrorAction SilentlyContinue) {
            Write-Host "Found simplifia.exe at versioned Scripts"
            Add-Content -Path $env:GITHUB_PATH -Value $versionedScripts
          }
          # Then plain USER_BASE\Scripts
          elseif (Test-Path "$plainScripts\simplifia.exe" -ErrorAction SilentlyContinue) {
            Write-Host "Found simplifia.exe at plain Scripts"
            Add-Content -Path $env:GITHUB_PATH -Value $plainScripts
          }
          # Then system Scripts
          elseif (Test-Path "$systemScripts\simplifia.exe" -ErrorAction SilentlyContinue) {
            Write-Host "Found simplifia.exe at system Scripts"
            Add-Content -Path $env:GITHUB_PATH -Value $systemScripts
          }
          else {
            Write-Host "simplifia.exe not found in expected locations, adding all to PATH"
            Add-Content -Path $env:GITHUB_PATH -Value $versionedScripts
            Add-Content -Path $env:GITHUB_PATH -Value $plainScripts
            Add-Content -Path $env:GITHUB_PATH -Value $systemScripts
          }
          
          # Show final PATH additions
          Write-Host "GITHUB_PATH content:"
          Get-Content $env:GITHUB_PATH
          
      - name: Verify CLI
        shell: pwsh
        run: |
          simplifia --version
          
      - name: Run doctor
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia doctor
          
      - name: List packs
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia list
          
      - name: Install WhatsApp pack
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia install whatsapp
          
      - name: Test WhatsApp pack
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia test whatsapp
          
      - name: Show status
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia status
