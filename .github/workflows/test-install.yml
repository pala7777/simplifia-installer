name: Test Clean Install

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Show environment
        run: |
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
          echo "Python: $(python3 --version)"
          echo "Docker: $(docker --version)"
          
      - name: Clean environment (remove any pre-existing)
        run: |
          rm -rf ~/.simplifia ~/.local/bin/simplifia 2>/dev/null || true
          pip3 uninstall simplifia -y 2>/dev/null || true
          
      - name: Run installer
        run: |
          curl -fsSL https://raw.githubusercontent.com/pala7777/simplifia-installer/main/packaging/install.sh | SIMPLIFIA_NONINTERACTIVE=1 bash
          
      - name: Add to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
        
      - name: Verify CLI
        run: |
          simplifia --version
          
      - name: Run doctor
        run: |
          simplifia doctor
          
      - name: List packs
        run: |
          simplifia list
          
      - name: Install WhatsApp pack
        run: |
          simplifia install whatsapp
          
      - name: Test WhatsApp pack
        run: |
          simplifia test whatsapp
          
      - name: Show status
        run: |
          simplifia status
          
      # NOTE: Runtime test skipped - Docker image not yet published
      # TODO: Enable when ghcr.io/clawdbot/clawdbot image is available
      # - name: Test runtime install (Docker)
      #   run: |
      #     simplifia clawdbot doctor
      #     SIMPLIFIA_NONINTERACTIVE=1 simplifia clawdbot install --docker
      #     simplifia clawdbot start
      #     sleep 10
      #     docker ps
      #     simplifia clawdbot status
      
      - name: Verify clawdbot install (without running)
        run: |
          simplifia clawdbot doctor
          SIMPLIFIA_NONINTERACTIVE=1 simplifia clawdbot install --docker || true
          ls -la ~/.simplifia/clawdbot/
          cat ~/.simplifia/clawdbot/docker-compose.yml

  test-windows:
    runs-on: windows-latest
    
    steps:
      - name: Show environment
        shell: pwsh
        run: |
          Write-Host "OS: $([System.Environment]::OSVersion)"
          Write-Host "Python: $(python --version)"
          Write-Host "Docker: $(docker --version)"
          
      - name: Clean environment
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force "$env:USERPROFILE\.simplifia" -ErrorAction SilentlyContinue
          pip uninstall simplifia -y 2>$null
          
      - name: Run installer
        shell: pwsh
        run: |
          $env:SIMPLIFIA_NONINTERACTIVE = "1"
          $env:PYTHONIOENCODING = "utf-8"
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001
          irm https://raw.githubusercontent.com/pala7777/simplifia-installer/main/packaging/install.ps1 | iex
          
      - name: Add Python Scripts to PATH
        shell: pwsh
        run: |
          $userBase = (python -c "import site; print(site.USER_BASE)").Trim()
          $scriptsPath = Join-Path $userBase "Scripts"
          Write-Host "Scripts path: $scriptsPath"
          Write-Host "Exists: $(Test-Path $scriptsPath)"
          Get-ChildItem $scriptsPath -ErrorAction SilentlyContinue | Select -First 5
          Add-Content -Path $env:GITHUB_PATH -Value $scriptsPath
          Write-Host "Added to GITHUB_PATH"
          
      - name: Verify CLI
        shell: pwsh
        run: |
          Write-Host "PATH: $env:PATH"
          Get-Command simplifia -ErrorAction SilentlyContinue
          simplifia --version
          
      - name: Run doctor
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia doctor
          
      - name: List packs
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia list
          
      - name: Install WhatsApp pack
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia install whatsapp
          
      - name: Test WhatsApp pack
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia test whatsapp
          
      - name: Show status
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          simplifia status
